# camel-k: property=file:../../properties/configs.properties

# Camel Route Design: rest -> unmarshal -> velocity -> kafka

- route:
    id: processCustomerData-rest
    from:
      uri: rest:post:/api/v1/processCustomerData
      parameters:
        consumes: application/json
        produces: application/json
      steps:
        - doTry:
            steps:
              ## rest -> unmarshal -> velocity -> kafka
              
              ## Step 1: Unmarshal
              - unmarshal:
                  json:
                    library: Jackson
              
              ## Step 2: Velocity
              - to:
                  uri: velocity
                  parameters:
                    allowContextMapAll: true
                    resourceUri: file:WebmethodsFlowServices_processCustomerData.vm
              - log: ------------> ${body}
              - unmarshal:
                  json:
                    library: Jackson
              - marshal:
                  json:
                    library: Jackson
              ## Step 3: Kafka
              - to:
                  uri: kafka
                  parameters:
                    brokers: pkc-619z3.us-east1.gcp.confluent.cloud:9092
                    requestRequiredAcks: all
                    saslJaasConfig: org.apache.kafka.common.security.plain.PlainLoginModule required
                      username='CNWJHHUTOJZOCO7B'
                      password='cflt4Ql5yM08e9LZlf2gdD5mpPjemyZV5O7DUf5WnvYuuj/sMMYQVv+TjioVlrtg';
                    saslMechanism: PLAIN
                    securityProtocol: SASL_SSL
                    topic: crm_customer_profile_v1
            doCatch:
              - exception:
                  - "java.lang.Exception"
                steps:
                  - log:
                      message: "[processCustomerData] Error: ${exception.message}"
                      loggingLevel: "ERROR"
                  
                  - setHeader:
                      name: "Content-Type"
                      constant: "application/json"
                  
                  - setHeader:
                      name: "CamelHttpResponseCode"
                      constant: "500"
                  
                  - setBody:
                      simple: |
                        {
                          "error": "Processing Error",
                          "message": "${exception.message}",
                          "timestamp": "${date:now:yyyy-MM-dd'T'HH:mm:ss}"
                        }
                  
                  - marshal:
                      json: {}
